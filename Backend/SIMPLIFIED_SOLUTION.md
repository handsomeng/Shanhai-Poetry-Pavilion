# 🎯 简化方案 - 已发布诗歌可直接编辑更新

> 用户决策：本地改了云端也一起改，不做版本分离

---

## 📋 核心逻辑

### ✅ 简化后的规则
```
1. 已发布的诗歌可以编辑
2. 编辑后可以直接更新云端版本
3. 点赞数据保留（因为是同一首诗的更新）
4. 需要重新审核
```

### 🔄 操作流程
```
已发布的诗歌
    ↓
点击"编辑"
    ↓
修改标题/内容
    ↓
点击"保存"
    ↓
Toast: "已保存"
    ↓
返回详情页
    ↓
按钮从 [✓已发布到广场] 变为 [更新到广场]
    ↓
点击"更新到广场"
    ↓
提交审核
    ↓
  ┌──────┴──────┐
  ↓             ↓
审核通过      审核驳回
  ↓             ↓
云端更新      提示修改
点赞保留      可重新提交
```

---

## 🎨 UI 设计

### 场景 1：诗集详情页（已发布，未修改）
```
┌────────────────────────┐
│ ← 返回   诗歌详情       │
├────────────────────────┤
│                        │
│   《春天》              │
│   正文内容...           │
│                        │
├────────────────────────┤
│                        │
│ [ 编辑 ] [✓已发布到广场]│
│                        │
│    [ AI 点评 ]         │
│    [ 删除 ]            │
│                        │
└────────────────────────┘
```

### 场景 2：编辑已发布的诗歌
```
┌────────────────────────┐
│      编辑诗歌           │
├────────────────────────┤
│                        │
│  标题: [修改内容]       │
│                        │
│  正文:                 │
│  [修改内容]            │
│                        │
│                        │
│     [ 保存 ]           │ ← 检测到修改，按钮启用
│                        │
└────────────────────────┘

点击"保存"后：
→ 保存到本地
→ Toast: "✅ 已保存"
→ 返回详情页
```

### 场景 3：编辑后的详情页
```
┌────────────────────────┐
│ ← 返回   诗歌详情       │
├────────────────────────┤
│                        │
│   《春天（新版）》       │ ← 修改后的内容
│   新的正文内容...       │
│                        │
├────────────────────────┤
│                        │
│ [ 编辑 ] [ 更新到广场 ] │ ← 按钮文案改变
│                        │
│    [ AI 点评 ]         │
│    [ 删除 ]            │
│                        │
└────────────────────────┘
```

### 场景 4：点击"更新到广场"
```
提交审核
    ↓
按钮变为 [审核中...]（禁用）
    ↓
Toast: "已提交审核，审核通常需要 1-2 分钟"
```

### 场景 5：审核通过
```
按钮变为 [✓已发布到广场]（置灰）
    ↓
Toast: "✅ 审核通过，已更新到广场"
    ↓
云端版本更新
点赞数据保留
```

### 场景 6：审核驳回
```
按钮变为 [ 重新提交 ]（红色文字）
    ↓
Toast: "❌ 审核未通过：[原因]"
    ↓
点击"重新提交" → 显示驳回原因详情
    ↓
修改内容后可再次提交
```

---

## 🚨 关键问题：审核期间云端显示什么？

### 问题场景
```
用户编辑了已发布的《春天》
    ↓
点击"更新到广场"
    ↓
提交审核（需要1-2分钟）
    ↓
❓ 审核期间：
   - 广场还显示旧版本？
   - 还是显示"审核中"？
   - 还是直接下线？
```

### 方案对比

#### 方案 A：审核期间保留旧版本（推荐）✨
```
审核中：
- 广场显示：旧版本（正常展示）
- 用户诗集：新版本
- 按钮状态：[审核中...]

审核通过：
- 广场显示：新版本（自动替换）
- 点赞数据：保留并迁移

审核驳回：
- 广场显示：旧版本（保持不变）
- 用户诗集：新版本（可继续修改）
```

**优点**：
- ✅ 审核期间诗歌仍可见
- ✅ 不影响用户互动
- ✅ 驳回后不会丢失旧版本

**缺点**：
- ⚠️ 短时间内本地和云端不一致

---

#### 方案 B：审核期间下线
```
审核中：
- 广场显示：[该诗歌审核中，暂不可见]
- 用户诗集：新版本
- 按钮状态：[审核中...]

审核通过：
- 广场显示：新版本（重新上线）

审核驳回：
- 广场显示：[该诗歌审核未通过]
- 或恢复旧版本
```

**优点**：
- ✅ 避免本地云端不一致

**缺点**：
- ❌ 审核期间诗歌不可见
- ❌ 影响用户互动（点赞/评论）
- ❌ 如果驳回，旧版本已丢失

---

#### 方案 C：立即更新，事后审核
```
点击"更新到广场"：
- 立即更新云端
- 后台异步审核

审核驳回：
- 自动下线
- 通知用户修改
```

**优点**：
- ✅ 用户体验流畅

**缺点**：
- ❌ 可能有短时间展示违规内容
- ❌ 需要强力的审核机制

---

### 我的推荐：方案 A（审核期间保留旧版本）

**理由**：
1. ✅ 平衡了审核严格性和用户体验
2. ✅ 不会因为审核而影响现有互动
3. ✅ 如果驳回，用户不会失去内容

---

## 📊 数据结构设计

### Poem 模型
```swift
struct Poem: Codable {
    var id: UUID
    var title: String
    var content: String
    var squareId: String?          // 云端ID
    var auditStatus: AuditStatus   // 审核状态
    var hasUnpublishedChanges: Bool // 是否有未发布的本地修改
}

enum AuditStatus: String, Codable {
    case notPublished     // 未发布
    case published        // 已发布（审核通过）
    case pending          // 审核中
    case rejected         // 审核驳回
}
```

### 状态管理逻辑
```swift
// 1. 编辑已发布的诗歌
func editPublishedPoem(_ poem: Poem) {
    poem.hasUnpublishedChanges = true
    // 保存修改
}

// 2. 更新到广场
func updateToSquare(_ poem: Poem) async throws {
    poem.auditStatus = .pending
    
    // 提交审核
    let result = try await poemService.updatePoem(
        id: poem.squareId!,
        title: poem.title,
        content: poem.content
    )
    
    if result.approved {
        poem.auditStatus = .published
        poem.hasUnpublishedChanges = false
    } else {
        poem.auditStatus = .rejected
    }
}

// 3. 详情页按钮显示逻辑
func getPublishButtonState() -> ButtonState {
    switch poem.auditStatus {
    case .notPublished:
        return .publish("发布到广场")
    case .published:
        if poem.hasUnpublishedChanges {
            return .update("更新到广场")
        } else {
            return .published("✓已发布到广场")
        }
    case .pending:
        return .pending("审核中...")
    case .rejected:
        return .retry("重新提交")
    }
}
```

---

## 🔄 完整交互流程图

```
已发布诗歌（审核通过）
    ↓
点击"编辑"
    ↓
修改内容
    ↓
点击"保存"
    ↓
hasUnpublishedChanges = true
    ↓
按钮变为 [更新到广场]
    ↓
点击"更新到广场"
    ↓
提交审核（auditStatus = pending）
    ↓
按钮变为 [审核中...]
    ↓
广场：显示旧版本（方案A）
    ↓
  ┌──────┴──────┐
  ↓             ↓
审核通过      审核驳回
  ↓             ↓
云端更新      按钮变红
点赞保留      [重新提交]
按钮恢复      显示原因
[✓已发布]     可修改重试
```

---

## 🎯 关于"已发布"Tab

### 问题：显示哪个版本？

#### 情况 1：审核期间
```
已发布Tab 显示：旧版本（云端）
诗集Tab 显示：新版本（本地）

在卡片上标注：
┌───────────────────┐
│ 《春天》          │
│ 正文内容...       │
│ 👍 89             │
│                   │
│ 🔄 新版本审核中   │ ← 提示
└───────────────────┘
```

#### 情况 2：审核通过
```
已发布Tab 显示：新版本（云端）
诗集Tab 显示：新版本（本地）

两边一致 ✅
```

#### 情况 3：审核驳回
```
已发布Tab 显示：旧版本（云端）
诗集Tab 显示：新版本（本地）

诗集卡片标注：
┌───────────────────┐
│ 《春天》          │
│ 新版本内容...     │
│                   │
│ ❌ 审核未通过     │ ← 提示
│   [查看原因]      │
└───────────────────┘
```

---

## 📝 开发任务清单

### Phase 1：数据模型扩展（30分钟）
- [ ] 添加 `auditStatus` 枚举
- [ ] 添加 `hasUnpublishedChanges` 字段
- [ ] 实现状态转换逻辑

### Phase 2：编辑逻辑（1小时）
- [ ] 允许编辑已发布诗歌
- [ ] 编辑后自动标记 `hasUnpublishedChanges = true`
- [ ] 保存后返回详情页

### Phase 3：按钮状态管理（1小时）
- [ ] 根据 `auditStatus` 和 `hasUnpublishedChanges` 显示不同按钮
- [ ] 实现按钮状态切换动画
- [ ] 禁用/启用逻辑

### Phase 4：更新到广场（2小时）
- [ ] 实现 `updatePoem` API
- [ ] 提交审核逻辑
- [ ] 审核结果处理（通过/驳回）
- [ ] Toast 提示

### Phase 5："已发布"Tab 优化（1小时）
- [ ] 检测审核状态
- [ ] 显示"审核中"/"审核未通过"标签
- [ ] 数据刷新逻辑

### Phase 6：测试和优化（30分钟）
- [ ] 完整流程测试
- [ ] 边界情况处理
- [ ] UI/UX 优化

**总计**：约 6 小时（比版本分离方案少 2 小时）

---

## ✅ 方案优势

### 相比版本分离方案
1. ✅ **开发时间减少**：6小时 vs 8小时
2. ✅ **逻辑更简单**：不需要管理两个版本
3. ✅ **用户理解容易**：编辑就是更新，很直观
4. ✅ **点赞数据保留**：用户不会因为修改而失去互动

### 相比完全禁止编辑
1. ✅ **更灵活**：用户可以修正错别字、优化内容
2. ✅ **体验更好**：不需要删除重发

---

## 💬 还需要你确认 2 个问题

### ❓ 问题 1：审核期间云端显示什么？
- [ ] **方案 A**：保留旧版本，审核通过后替换（推荐）
- [ ] **方案 B**：审核期间下线
- [ ] **方案 C**：立即更新，事后审核

### ❓ 问题 2：审核是同步还是异步？
- [ ] **同步**：提交后1-2秒返回结果
- [ ] **异步**：提交后需要等待，1-2分钟或更长

---

## 📝 请回复

**快速确认**：
```
审核期间：方案 A / B / C
审核方式：同步 / 异步
```

确认后我立即开始开发！预计 **6 小时**完成 🚀

