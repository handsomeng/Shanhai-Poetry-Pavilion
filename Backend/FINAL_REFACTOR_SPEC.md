# 📋 诗歌操作重构最终方案

> **版本**: V3 Final  
> **日期**: 2025-10-23  
> **状态**: ✅ 已确认，待开发

---

## 🎯 核心设计原则

### 1. 数据存储策略
```
本地存储：
├─ 草稿（未完成的诗歌）
├─ 诗集（已完成的诗歌）
└─ 缓存数据

云端存储：
└─ 已发布到广场的诗歌
```

**说明**：
- ✅ 草稿和诗集全部存本地（UserDefaults）
- ✅ 只有发布到广场的诗歌才上传云端（Supabase）
- ✅ 登录前后数据存储位置不变
- ✅ 简化数据同步逻辑

### 2. 操作逻辑简化
```
写诗页面：
└─ 只有 1 个"保存"按钮（之前是 3 个）

编辑模式：
├─ 未修改：显示"退出"按钮
└─ 已修改：显示"保存"按钮（自动切换）

保存成功：
└─ 统一显示成功页面 + 4 个操作按钮
```

---

## 📝 详细操作流程

## 一、写诗页面

### 1.1 写诗中
```
界面元素：
- 顶部导航栏：[取消] 写诗 [?]
- 标题输入框（可选）
- 正文输入框
- 字数统计
- 底部唯一按钮：[保存到诗集]

按钮状态：
- 内容为空：禁用（灰色）
- 有内容：启用（青色）
```

**说明**：
- ✅ 使用"保存到诗集"而非"保存"，更明确操作结果
- ✅ 避免用户误以为只是临时保存

### 1.2 点击"取消"（未保存内容）
```
触发条件：
- 用户点击左上角"取消"
- 且诗歌内容不为空

弹窗内容：
┌────────────────────┐
│   ⚠️ 确认退出？    │
│                    │
│  诗歌尚未保存       │
│  将自动保存到草稿   │
│                    │
│ [直接退出][继续写]  │
└────────────────────┘

交互逻辑：
1. 点击"直接退出"：
   → 自动保存到草稿（本地）
   → Toast: "✅ 已自动保存到草稿"
   → 关闭写诗页面

2. 点击"继续写"：
   → 关闭弹窗
   → 继续编辑
```

### 1.3 点击"保存到诗集"
```
执行步骤：
1. 保存诗歌到本地诗集（UserDefaults）
2. 立即生成诗歌分享图片（内存中，不保存到相册）
3. 显示成功页面（半屏弹窗）
4. Toast: "✅ 已保存到你的诗集"

成功页面布局：
┌────────────────────────┐
│ × 关闭                  │
├────────────────────────┤
│                        │
│   🖼️ 诗歌分享图片       │
│                        │
│    《标题》             │
│                        │
│   正文内容...           │
│                        │
│  ─ 作者名 · 日期 ─     │
│                        │
├────────────────────────┤
│                        │
│ [AI点评][保存图片][分享]│
│                        │
│   [ 🎯 发布到广场 ]    │
│                        │
└────────────────────────┘

4个按钮功能：
1. ✨ AI 点评
   → 调用 AI 服务，显示点评弹窗

2. 💾 保存图片
   → 将生成的诗歌图片保存到系统相册
   → Toast: "✅ 图片已保存到相册"
   → 注意：图片在点击"保存到诗集"时已生成（内存中），此时才真正保存到相册

3. 📤 分享
   → 将图片保存到临时目录
   → 唤醒系统分享面板（UIActivityViewController）
   → 可分享到微信/朋友圈/微博等第三方平台

4. 🎯 发布到广场
   → 未登录：弹出登录页面
   → 已登录：上传到 Supabase
   → 成功后 Toast: "✅ 已发布到广场"
   → 按钮变为 "✓ 已发布"（置灰）
```

**⚠️ 重要说明**：
- **诗歌保存时机**：点击"保存到诗集"后立即保存到本地（UserDefaults）
- **图片生成时机**：点击"保存到诗集"后立即在内存中生成
- **图片保存时机**：
  - 点击"保存图片" → 保存到系统相册
  - 点击"分享" → 保存到临时目录 → 分享面板
- **成功页面关闭**：点击"×"关闭成功页面，同时退出写诗流程

---

## 二、我的页面 - 诗集 Tab

### 2.1 诗集列表
```
显示内容：
- 所有已保存到诗集的诗歌
- 诗歌卡片：标题/内容预览/创作方式/日期

操作方式：
1. 点击卡片 → 进入诗歌详情页
2. 左滑卡片 → 显示删除按钮
```

### 2.2 诗歌详情页（未发布）
```
界面布局：
┌────────────────────────┐
│ ← 返回   诗歌详情       │
├────────────────────────┤
│                        │
│   《标题》              │
│                        │
│   正文内容...           │
│                        │
│   创作方式 · 日期       │
│                        │
├────────────────────────┤
│                        │
│  [ 编辑 ]  [ 发布 ]    │
│                        │
│     [ AI 点评 ]        │
│                        │
│     [ 删除 ]           │  ← 新增
│                        │
└────────────────────────┘

按钮功能：
1. 编辑 → 进入编辑模式（见下文）
2. 发布到广场 → 发布到云端（同写诗页面）
3. AI 点评 → AI 点评弹窗
4. 删除 → 删除确认弹窗（见下文）
```

### 2.3 诗歌详情页（已发布）
```
界面布局：
┌────────────────────────┐
│ ← 返回   诗歌详情       │
├────────────────────────┤
│                        │
│   《标题》              │
│   正文内容...           │
│                        │
├────────────────────────┤
│                        │
│  [ 编辑 ]  [✓ 已发布]  │  ← 已发布按钮置灰
│                        │
│     [ AI 点评 ]        │
│                        │
│     [ 删除 ]           │
│                        │
└────────────────────────┘

特殊说明：
- "编辑"按钮：不可用（已发布诗歌不可编辑）
- "已发布"按钮：置灰，点击时 Toast: "✓ 该诗歌已发布到广场"
- "删除"按钮：正常可用
```

### 2.4 删除确认
```
触发方式：
1. 详情页点击"删除"按钮
2. 列表左滑点击"删除"

弹窗内容：
┌────────────────────┐
│   ⚠️ 确认删除？    │
│                    │
│  删除后无法恢复     │
│                    │
│ [取消]    [删除]   │
└────────────────────┘

交互逻辑：
- 点击"取消" → 关闭弹窗
- 点击"删除" → 删除诗歌 + Toast: "✅ 已删除"
```

---

## 三、编辑模式

### 3.1 进入编辑模式
```
入口：
- 诗集详情页点击"编辑"按钮

界面：
- 与写诗页面相同（标题输入框 + 正文输入框）
- 预填充现有内容
- 顶部标题显示"编辑诗歌"
```

### 3.2 未修改状态
```
界面布局：
┌────────────────────────┐
│      编辑诗歌           │
├────────────────────────┤
│                        │
│  标题: [预填充内容]     │
│                        │
│  正文:                 │
│  [预填充内容]           │
│                        │
│                        │
│      [ 退出 ]          │  ← 灰色按钮
│                        │
└────────────────────────┘

交互逻辑：
- 点击"退出" → 直接返回详情页（无需确认）
- 内容未修改，无需保存
```

### 3.3 已修改状态
```
界面布局：
┌────────────────────────┐
│      编辑诗歌           │
├────────────────────────┤
│                        │
│  标题: [修改后内容]     │
│                        │
│  正文:                 │
│  [修改后内容]           │
│                        │
│                        │
│     [ 保存 ]           │  ← 青色按钮（自动切换）
│                        │
└────────────────────────┘

交互逻辑：
- 点击"保存" → 执行保存流程
  1. 更新诗歌内容（保持原有 ID 和创建时间）
  2. Toast: "✅ 已保存"
  3. 返回详情页

⚠️ 注意：
- 编辑模式的保存按钮保持"保存"即可（不用"保存到诗集"）
- 因为诗歌已经在诗集里，用户只是在更新内容
- 编辑保存后不显示成功页面，直接回到详情页（更流畅）
```

---

## 四、我的页面 - 草稿 Tab

### 4.1 草稿列表
```
显示内容：
- 所有未完成的草稿
- 草稿卡片：标题/内容预览/草稿标识/时间

操作方式：
1. 点击卡片 → 直接进入编辑模式（不是详情页）
2. 左滑卡片 → 显示删除按钮
```

### 4.2 编辑草稿
```
界面：
- 与写诗页面相同
- 预填充草稿内容
- 顶部标题显示"编辑草稿"

底部按钮：
- [ 保存到诗集 ] （青色）

点击"保存到诗集"：
1. 从草稿列表删除该草稿
2. 保存到本地诗集
3. 生成诗歌分享图片
4. 显示成功页面 + 4个按钮
5. Toast: "✅ 已保存到你的诗集"

⚠️ 注意：
- 草稿编辑使用"保存到诗集"按钮（同写诗页面）
- 因为草稿保存后会移动到诗集，操作结果需要明确
```

### 4.3 取消编辑草稿
```
触发：
- 点击左上角"取消"

弹窗内容：
┌────────────────────────┐
│   ⚠️ 确认退出？        │
│                        │
│  选择如何处理草稿：     │
│                        │
│  [ 保存草稿 ]          │  ← 保存修改
│  [ 不修改草稿 ]        │  ← 放弃修改
│  [ 继续编辑 ]          │  ← 继续
│                        │
└────────────────────────┘

交互逻辑：
1. 保存草稿：
   → 保存当前修改
   → Toast: "✅ 草稿已保存"
   → 关闭编辑页面
   → 草稿仍在草稿 Tab

2. 不修改草稿：
   → 放弃所有修改
   → 恢复原草稿内容
   → 关闭编辑页面
   → 草稿仍在草稿 Tab

3. 继续编辑：
   → 关闭弹窗
   → 继续编辑
```

---

## 五、我的页面 - 已发布 Tab

### 5.1 已发布列表
```
显示内容：
- 所有已发布到广场的诗歌
- 诗歌卡片：标题/内容/互动数据（👍💬⭐）

操作方式：
- 点击卡片 → 进入详情页（只读）
- 不支持左滑删除（已发布诗歌只能从云端管理）
```

### 5.2 已发布详情页
```
界面布局：
┌────────────────────────┐
│ ← 返回   诗歌详情       │
├────────────────────────┤
│                        │
│   《标题》              │
│   正文内容...           │
│                        │
│  👍 89  💬 12  ⭐ 34   │  ← 广场互动数据
│                        │
│  创作方式 · 发布时间    │
│                        │
├────────────────────────┤
│                        │
│ [ 📢 查看广场讨论 ]    │  → 跳转到广场
│                        │
│    [ ✨ AI 点评 ]      │
│                        │
└────────────────────────┘

特殊说明：
- 已发布诗歌不可编辑
- 不显示"删除"按钮（云端诗歌只能从广场删除）
- 可查看广场互动数据
- 可触发 AI 点评
```

---

## 🔄 完整交互流程图

### 写诗流程
```
开始写诗
    │
    ├─ [保存] ──────┐
    │               ↓
    │          保存到诗集
    │               ↓
    │          生成图片
    │               ↓
    │          成功页面
    │               ↓
    │       ┌───────┼───────┐
    │       ↓       ↓       ↓       ↓
    │    AI点评  保存图片  分享  发布广场
    │                               ↓
    │                            云端存储
    │                               ↓
    │                          已发布Tab
    │
    └─ [取消] → 确认弹窗 → 自动草稿 → 草稿Tab
```

### 诗集编辑流程
```
诗集卡片
    │
    ├─ 点击 → 详情页 ──┐
    │                  ├─ [编辑] → 编辑模式
    │                  │               │
    │                  │          ┌────┴────┐
    │                  │          ↓         ↓
    │                  │       未修改     已修改
    │                  │          ↓         ↓
    │                  │       [退出]   [保存]
    │                  │                   ↓
    │                  │              成功页面
    │                  │
    │                  ├─ [发布] → 云端
    │                  ├─ [AI点评] → 弹窗
    │                  └─ [删除] → 确认弹窗
    │
    └─ 左滑 → [删除] → 确认弹窗
```

### 草稿编辑流程
```
草稿卡片
    │
    ├─ 点击 → 编辑模式 ──┐
    │                    ├─ [保存] → 成功页面
    │                    │             ↓
    │                    │        移动到诗集Tab
    │                    │
    │                    └─ [取消] → 确认弹窗
    │                                  │
    │                         ┌────────┼────────┐
    │                         ↓        ↓        ↓
    │                      保存草稿  不修改  继续编辑
    │
    └─ 左滑 → [删除] → 确认弹窗
```

---

## 📊 数据流转

### 诗歌状态转换
```
写诗 ──[取消/退出]──→ 草稿 ──[保存到诗集]──→ 诗集 ──[发布]──→ 已发布
                                      ↓
                                   [删除]
                                      ↓
                                     删除

特殊规则：
1. 草稿 → 诗集：删除草稿，新增诗集
2. 诗集 → 已发布：诗集保留，新增云端记录
3. 已发布诗歌：不可删除本地，不可编辑
```

### 存储位置
```
草稿：
└─ UserDefaults["drafts"]
   └─ [Poem] 数组

诗集：
└─ UserDefaults["collection"]
   └─ [Poem] 数组

已发布：
├─ 本地：UserDefaults["collection"]
│  └─ poem.squareId 不为空
└─ 云端：Supabase.poems 表
```

---

## 🎨 UI/UX 规范

### 按钮样式
```
主要操作按钮：
- 颜色：青色 (Colors.accentTeal)
- 形状：圆角矩形
- 文字：白色，加粗
- 示例：[保存到诗集] [发布到广场]

次要操作按钮：
- 颜色：白色背景，深灰文字
- 形状：圆角矩形
- 边框：浅灰色
- 示例：[编辑] [AI点评]

禁用状态：
- 颜色：浅灰色背景
- 文字：灰色
- 不可点击
```

### Toast 提示
```
成功提示：
- ✅ 已保存到你的诗集
- ✅ 已发布到广场
- ✅ 图片已保存到相册
- ✅ 已自动保存到草稿
- ✅ 草稿已保存
- ✅ 已删除

信息提示：
- ✓ 该诗歌已发布到广场

错误提示：
- ❌ 发布失败，请重试
- ❌ 保存失败，请重试
```

### 弹窗样式
```
确认弹窗：
- 标题：⚠️ + 文字（加粗）
- 内容：说明文字（常规）
- 按钮：左侧取消，右侧确认
- 圆角：16pt
- 背景：白色 + 阴影
```

---

## ⚠️ 需要再次确认的细节

### ❓ 疑问 1：成功页面的"保存图片"按钮
**我的理解**：
- 点击写诗的"保存"按钮后，诗歌已保存到本地诗集
- 成功页面显示生成的分享图片
- "保存图片"按钮的作用是：将图片保存到相册

**你的回答**：
> "保存图片"按钮 —— 不是，是保存到诗集

**🤔 我的困惑**：
- 诗歌不是已经保存到诗集了吗？（Toast 提示："已保存到你的诗集"）
- 这个按钮是否应该改名为"保存图片到相册"？
- 还是说有其他功能？

**请明确**：
- [ ] 按钮名称："保存图片"（保存到相册）
- [ ] 按钮名称："保存到诗集"（功能是？）
- [ ] 其他：__________

---

### ❓ 疑问 2：图片生成和保存时机
**我的理解**：
- 点击写诗的"保存"按钮后：
  1. 诗歌保存到本地诗集 ✅
  2. 立即生成诗歌分享图片（内存中）✅
  3. 显示成功页面，展示图片 ✅
  4. 图片**不自动保存到相册** ✅
- 点击"保存图片"按钮后：
  1. 将图片保存到相册 ✅
- 点击"分享"按钮后：
  1. 将图片保存到临时目录 ✅
  2. 唤醒系统分享面板 ✅

**请确认**：
- [ ] ✅ 正确，按这个理解开发
- [ ] ❌ 不对，具体是：__________

---

## 📋 开发任务清单

### Phase 1：写诗页面重构（4小时）
- [ ] 移除"诗集"和"草稿"按钮，保留唯一"保存"按钮
- [ ] 实现取消确认弹窗
- [ ] 实现自动草稿保存
- [ ] 创建成功页面（PoemSuccessView）
- [ ] 实现诗歌分享图片生成（PoemImageGenerator）
- [ ] 集成 4 个操作按钮
- [ ] 更新 DirectWritingView
- [ ] 更新 MimicWritingView
- [ ] 更新 ThemeWritingView

### Phase 2：诗集页面重构（3小时）
- [ ] 添加详情页"删除"按钮
- [ ] 实现左滑删除手势
- [ ] 实现删除确认弹窗
- [ ] 重构编辑模式按钮切换逻辑（退出/保存）
- [ ] 编辑保存后跳转到成功页面
- [ ] 更新已发布状态判断
- [ ] 禁用已发布诗歌的编辑按钮
- [ ] 更新 PoemEditorDetailView

### Phase 3：草稿页面重构（2小时）
- [ ] 点击草稿直接进入编辑
- [ ] 实现取消确认弹窗（3个选项）
- [ ] 草稿保存后移动到诗集
- [ ] 实现左滑删除
- [ ] 更新 ProfileView

### Phase 4：数据逻辑优化（1小时）
- [ ] 统一本地存储逻辑
- [ ] 草稿和诗集互相转换
- [ ] 发布状态同步
- [ ] 删除操作优化

### Phase 5：测试和优化（2小时）
- [ ] 完整流程测试
- [ ] 边界情况处理
- [ ] UI/UX 细节优化
- [ ] 性能优化

**总计**: 约 12 小时

---

## ✅ 确认清单

在开始开发前，请确认以下内容：

- [ ] **疑问1已明确**："保存图片"按钮的功能
- [ ] **疑问2已确认**：图片生成和保存时机
- [ ] **所有流程已理解**：写诗/编辑/草稿/已发布
- [ ] **所有按钮功能已明确**：保存/编辑/删除/发布/AI点评
- [ ] **所有弹窗逻辑已确认**：取消/删除/草稿编辑
- [ ] **数据流转已清晰**：草稿→诗集→已发布

---

## 📝 最后确认

**请回复**：
1. ✅ **全部确认，开始开发**
2. ❌ **还有疑问**：（请说明）

确认后我立即开始重构！🚀

