# 🎯 用户方案评估

> 基于用户明确的需求进行技术评估和实现建议

---

## 📋 用户明确的需求

### ✅ 问题1：已发布诗歌的编辑逻辑
- **已发布的不能改**（云端版本锁定）
- 本地诗集可以编辑 → 本地看到 V2
- 云端广场不变 → 云端保持 V1
- **本地和云端版本分离**

### ✅ 问题2：不支持覆盖的原因
- **必须去广场删除 V1**
- **理由**：点赞是针对 V1 的内容，如果覆盖成 V2，会造成点赞作假
- **逻辑合理** ✅

### ✅ 问题3：用户提示方案
- 在"发布到广场"按钮**右上角显示小角标**
- 角标提示内容：
  > "因为你已经编辑了诗集，云端的诗集是不能直接覆盖的，你可以直接发布这首新的诗，与上一首不重复。如果有需要，可以去广场上把旧的诗删掉"

---

## 💡 方案评估

### ✅ 优点

1. **保证数据真实性**
   - ✅ 点赞数据不会作假
   - ✅ 用户点赞的是什么内容，就始终对应那个内容
   - ✅ 避免"换内容套数据"的问题

2. **逻辑清晰**
   - ✅ 本地 = 最新版本（可编辑）
   - ✅ 云端 = 已发布版本（不可变）
   - ✅ 一首诗 = 一个版本 = 一份互动数据

3. **技术可实现**
   - ✅ 不需要复杂的版本同步
   - ✅ 不需要冲突解决
   - ✅ 实现成本适中

### ⚠️ 需要注意的问题

#### 问题 A：用户理解成本
**场景**：
```
用户编辑了已发布的《春天》
    ↓
本地看到的是修改后的版本
    ↓
点击"发布到广场"
    ↓
发现角标提示"不能覆盖"
    ↓
❓ 用户可能困惑：
   "为什么我的诗集里是新版本，广场上是旧版本？"
   "我要怎么让广场显示新版本？"
   "为什么要分两个版本？"
```

**建议**：
- ✅ 第一次出现时，显示**全屏教学引导**
- ✅ 用简单的插图说明"本地诗集"和"广场版本"的区别
- ✅ 提供"不再提示"选项

---

#### 问题 B：角标的可见性
**场景**：
```
┌────────────────────────┐
│  [ 编辑 ] [ 发布到广场 ]🔴│ ← 小角标可能不够显眼
└────────────────────────┘
```

**建议**：使用更明显的 UI 提示

**方案 1**：角标 + 悬停提示（但移动端没有悬停）
```
┌────────────────────────┐
│  [ 编辑 ] [ 发布到广场 ]🔴│
│            ↑            │
│         点击查看详情     │
└────────────────────────┘
```

**方案 2**：黄色警告条（推荐）✨
```
┌────────────────────────┐
│  ⚠️ 本地版本已修改      │
│  不能覆盖广场的旧版本   │
│  [查看详情]             │
├────────────────────────┤
│  [ 编辑 ] [ 发布新版本 ]│
└────────────────────────┘
```

**方案 3**：按钮文案变化（最直观）✨
```
未修改时：
┌────────────────────────┐
│  [ 编辑 ] [ 发布到广场 ]│
└────────────────────────┘

已修改时：
┌────────────────────────┐
│  [ 编辑 ] [ 发布新版本 ]│ ← 按钮文案改变
│                    ⓘ   │ ← 信息按钮
└────────────────────────┘

点击 ⓘ → 显示详细说明
```

**我推荐：方案 2 + 方案 3 结合**
```
┌────────────────────────┐
│  ⚠️ 本地版本已修改      │ ← 黄色警告条
│  [了解更多]             │
├────────────────────────┤
│  [ 编辑 ] [ 发布新版本 ]│ ← 按钮文案改变
└────────────────────────┘
```

---

#### 问题 C："已发布"Tab 的困惑

**场景**：
```
诗集Tab：《春天》V2（本地，已修改）
已发布Tab：《春天》V1（云端，旧版本）

❓ 用户点击"已发布"Tab的《春天》，看到的是 V1
❓ 用户可能困惑："咦？我刚刚不是改过了吗？"
```

**建议**：在"已发布"Tab 的卡片上显示提示
```
┌───────────────────┐
│ 《春天》          │
│ 正文内容...       │
│ 👍 89             │
│                   │
│ ⚠️ 诗集中已更新    │ ← 提示
│   [查看诗集版本]  │
└───────────────────┘
```

---

#### 问题 D：数据结构设计

需要在 `Poem` 模型中新增字段：

```swift
struct Poem: Codable {
    // 现有字段
    var id: UUID
    var title: String
    var content: String
    var squareId: String?  // 云端ID
    
    // ===== 新增字段 =====
    
    /// 是否为已发布诗歌的本地修改版本
    var isLocalModifiedVersion: Bool = false
    
    /// 云端版本的快照（用于对比）
    var cloudVersionSnapshot: PoemSnapshot?
    
    /// 最后同步时间
    var lastSyncedAt: Date?
}

struct PoemSnapshot: Codable {
    let title: String
    let content: String
    let publishedAt: Date
}
```

**逻辑**：
```swift
// 1. 发布到广场时，保存快照
func publishToSquare(_ poem: Poem) {
    poem.cloudVersionSnapshot = PoemSnapshot(
        title: poem.title,
        content: poem.content,
        publishedAt: Date()
    )
    // ... 上传到云端
}

// 2. 编辑诗歌时，检查是否修改了已发布内容
func savePoemChanges(_ poem: Poem) {
    if let snapshot = poem.cloudVersionSnapshot {
        if poem.title != snapshot.title || 
           poem.content != snapshot.content {
            poem.isLocalModifiedVersion = true
        }
    }
    // ... 保存
}

// 3. 详情页显示逻辑
if poem.squareId != nil && poem.isLocalModifiedVersion {
    // 显示警告条 + "发布新版本"按钮
} else if poem.squareId != nil {
    // 显示"✓已发布到广场"按钮
} else {
    // 显示"发布到广场"按钮
}
```

---

#### 问题 E：去广场删除旧版本的流程

**场景**：用户想让广场显示新版本

**流程**：
```
1. 用户在诗集编辑了已发布的《春天》
    ↓
2. 想发布新版本
    ↓
3. 看到提示："不能覆盖旧版本"
    ↓
4. 点击"去广场删除旧版本"
    ↓
5. 跳转到广场，自动筛选出这首诗
    ↓
6. 用户点击删除
    ↓
7. 删除确认："删除后点赞数据会清除"
    ↓
8. 删除成功
    ↓
9. 返回诗集，提示："现在可以发布新版本了"
    ↓
10. 点击"发布新版本"
```

**技术实现**：
```swift
// 在详情页提供快捷入口
Button("去广场删除旧版本") {
    // 跳转到广场，带上 squareId
    navigationPath.append(
        ExploreDestination.poemDetail(squareId: poem.squareId!)
    )
}

// 在广场的诗歌详情页
if poem.authorId == currentUserId {
    Button("删除", role: .destructive) {
        showingDeleteConfirm = true
    }
}
```

**优化建议**：
- ✅ 提供"一键删除旧版本并发布新版本"功能
- ✅ 合并成一个操作，减少步骤

```swift
Button("替换广场版本") {
    showingReplaceConfirm = true
}
.alert("确认替换", isPresented: $showingReplaceConfirm) {
    Button("取消", role: .cancel) {}
    Button("替换", role: .destructive) {
        // 1. 删除云端旧版本
        // 2. 发布新版本
        // 3. 点赞数清零
    }
} message: {
    Text("替换后，旧版本的点赞数据会清除，确认替换？")
}
```

---

#### 问题 F：审核机制的集成

**用户需求**：
> 发布到广场的时候要有审核机制，如果被驳回或者发布成功，要有 toast 提示

**与编辑逻辑的结合**：

```
编辑已发布的诗歌
    ↓
点击"发布新版本"
    ↓
提交审核
    ↓
  ┌─────┴─────┐
  ↓           ↓
审核通过    审核驳回
  ↓           ↓
云端有新版本  提示修改
```

**如果审核驳回**：
```
❓ 旧版本还在云端吗？
✅ 在，旧版本不受影响

❓ 用户可以继续修改新版本吗？
✅ 可以，本地版本可以随时修改

❓ 修改后可以重新提交吗？
✅ 可以，直到审核通过或用户放弃
```

---

## 🎯 最终推荐方案

### 方案概述
```
用户方案的基础上，增加以下优化：
1. 添加教学引导（首次出现）
2. 使用黄色警告条 + 按钮文案变化（提高可见性）
3. 提供"一键替换"功能（减少操作步骤）
4. 在"已发布"Tab 显示版本差异提示
```

### UI 设计

#### 1. 诗集详情页（已发布且已修改）
```
┌─────────────────────────────┐
│ ← 返回   诗歌详情            │
├─────────────────────────────┤
│                             │
│   《春天》                   │
│   正文内容...（V2 新版本）   │
│                             │
├─────────────────────────────┤
│ ⚠️ 本地版本已修改            │
│ 广场上的是旧版本，不能直接    │
│ 覆盖。你可以：               │
│ • 发布为新诗（保留旧版本）    │
│ • 替换旧版本（清除点赞数据）  │
│ [了解更多]                   │
├─────────────────────────────┤
│                             │
│  [ 编辑 ] [ 发布新版本 ]    │ ← 按钮文案改变
│            [替换旧版本]      │ ← 新增按钮
│                             │
│     [ AI 点评 ]             │
│     [ 删除 ]                │
│                             │
└─────────────────────────────┘
```

#### 2. 点击"发布新版本"
```
→ 提交审核
→ Toast: "新版本已提交审核"
→ 按钮变为 [审核中...]（禁用）
```

#### 3. 点击"替换旧版本"
```
┌─────────────────────────┐
│   ⚠️ 确认替换？         │
│                         │
│ 替换后：                │
│ • 广场显示新版本         │
│ • 旧版本的 89 个赞会清除 │
│ • 需要重新审核           │
│                         │
│ [取消]    [确认替换]    │
└─────────────────────────┘
```

---

## 📊 技术实现评估

### 开发任务清单

#### Phase 1：数据模型扩展（1小时）
- [ ] 添加 `isLocalModifiedVersion` 字段
- [ ] 添加 `cloudVersionSnapshot` 字段
- [ ] 实现版本对比逻辑

#### Phase 2：UI 组件（2小时）
- [ ] 创建警告条组件（WarningBanner）
- [ ] 修改详情页布局
- [ ] 实现"替换旧版本"按钮
- [ ] 实现教学引导弹窗

#### Phase 3：业务逻辑（3小时）
- [ ] 编辑时自动标记为 `isLocalModifiedVersion`
- [ ] 发布时保存云端快照
- [ ] 实现"替换"功能（删除旧版+发布新版）
- [ ] 集成审核状态管理

#### Phase 4：已发布 Tab 优化（1小时）
- [ ] 检测本地版本差异
- [ ] 显示"诗集中已更新"提示
- [ ] 添加"查看诗集版本"跳转

#### Phase 5：测试和优化（1小时）
- [ ] 完整流程测试
- [ ] 边界情况处理
- [ ] UI/UX 优化

**总计**：约 8 小时

---

## ✅ 结论

### 你的方案是**可行的**，且**逻辑合理** ✅

**优点**：
1. ✅ 保证点赞数据真实性（核心价值）
2. ✅ 逻辑清晰，不会混淆版本
3. ✅ 技术上可实现

**建议优化**：
1. ✅ 增加教学引导（首次）
2. ✅ 使用明显的警告条（而非小角标）
3. ✅ 提供"一键替换"功能（简化流程）
4. ✅ 在"已发布"Tab 显示版本差异

**开发时间**：
- 基础实现：~6 小时
- 完善优化：~2 小时
- **总计：~8 小时**

---

## 💬 需要你最终确认

### ❓ 问题 1：是否采用我的优化建议？
- [ ] ✅ 采用（黄色警告条 + 一键替换 + 教学引导）
- [ ] ❌ 不需要，只要基础功能（小角标提示）

### ❓ 问题 2：审核是同步还是异步？
- [ ] 同步：提交后立即返回结果（秒级）
- [ ] 异步：需要等待审核（分钟到小时级）

### ❓ 问题 3：审核驳回后的提示
- [ ] 详细：显示具体原因（如"包含敏感词：XXX"）
- [ ] 简单：只显示"内容不符合规范"

---

## 📝 请回复

**快速确认**：
```
优化建议：采用 / 不需要
审核方式：同步 / 异步
驳回提示：详细 / 简单
```

确认后我立即开始开发！预计 8 小时完成 🚀

