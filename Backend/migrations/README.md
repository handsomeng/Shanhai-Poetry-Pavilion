# 数据库迁移脚本

## 修复诗人称号系统

### 问题描述
数据库的诗人称号系统与客户端代码不一致，导致显示错误的称号（如"拾字诗人"）。

### 解决方案
执行 `fix_poet_title_system.sql` 脚本，将数据库的称号系统更新为与客户端一致。

### 执行步骤

#### 方法1：在 Supabase Dashboard 执行（推荐）

1. 登录 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择你的项目
3. 点击左侧菜单 **SQL Editor**
4. 点击 **New Query**
5. 复制 `fix_poet_title_system.sql` 的全部内容
6. 粘贴到 SQL 编辑器
7. 点击 **Run** 按钮执行
8. 查看执行结果

#### 方法2：使用 Supabase CLI

```bash
# 确保已安装 Supabase CLI
supabase db push

# 或者直接执行 SQL 文件
supabase db execute --file migrations/fix_poet_title_system.sql
```

### 执行后的效果

✅ 更新称号计算函数，使其与客户端 `PoetTitle.swift` 一致

✅ 将所有现有用户的旧称号更新为新称号：
- `拾字诗人` → `初见诗人` 或 `寻山诗人`
- `听风诗人` → `听雨诗人` 或 `寻梅诗人`
- `踏雪诗人` → `寻梅诗人` 或 `望月诗人`
- `望山诗人` → `望月诗人` 或 `登高诗人`
- `观海诗人` → `登高诗人` 或 `山河诗人` 或 `谪仙诗人`

✅ 显示验证报告，确认更新成功

### 新的诗人称号系统

| 诗歌数量 | 称号 | 图标 | 描述 |
|---------|------|------|------|
| 1-5首 | 初见诗人 | 🌊 | 初入山海，诗心萌动 |
| 6-10首 | 寻山诗人 | ⛰️ | 开始探索诗歌山河 |
| 11-20首 | 听雨诗人 | ☁️ | 观云听雨，诗意渐浓 |
| 21-50首 | 寻梅诗人 | ❄️ | 踏雪寻梅，坚持不懈 |
| 51-100首 | 望月诗人 | 🌙 | 望月怀远，境界渐高 |
| 101-200首 | 登高诗人 | 🏔️ | 登高望远，视野开阔 |
| 201-500首 | 山河诗人 | 🗺️ | 经纬山河，笔力千钧 |
| 500+首 | 谪仙诗人 | ✨ | 诗仙之境，山海之间 |

### 验证更新

执行脚本后，你会看到一个验证报告，类似这样：

```
poet_title    | user_count | min_poems | max_poems
--------------+------------+-----------+----------
初见诗人      |     15     |     1     |     5
寻山诗人      |      8     |     6     |    10
听雨诗人      |      5     |    11     |    20
...
```

### 测试

1. 重启 App
2. 进入【我的】页面
3. 查看你的诗人称号
4. ✅ 5首诗应该显示 **初见诗人** 🌊

### 注意事项

⚠️ **执行前确保备份数据**（虽然这个脚本只是更新称号，不会删除数据）

⚠️ 如果你的 Supabase 项目中有很多用户，更新可能需要几秒钟时间

⚠️ 更新后，用户需要重新登录才能看到新的称号（或者杀掉 App 重新打开）

