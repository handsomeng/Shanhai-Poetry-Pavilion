# 诗集编辑逻辑优化

## 🎯 优化目标

将【我的-诗集】和【我的-草稿】的编辑逻辑从"直接进入编辑模式"改为"查看优先，按需编辑"，更符合"已保存内容"的交互逻辑。

---

## ✅ 新增功能

### 📄 新文件：`PoemEditorDetailView.swift`

专门用于诗集和草稿的查看/编辑详情页。

---

## 🎨 界面逻辑

### **查看模式**（默认）

```
┌─────────────────────────┐
│      诗歌标题            │
│                         │
│   诗歌正文内容...         │
│                         │
│   创作时间、创作方式      │
├─────────────────────────┤
│  [编辑]  [发布到广场]    │
│     [AI 点评]           │
└─────────────────────────┘
```

#### 按钮说明：
1. **【编辑】**
   - 点击进入编辑模式
   - 可以修改标题和内容

2. **【发布到广场】** / **【已发布广场】**
   - 如果 `poem.inSquare = false`：显示蓝色【发布到广场】按钮
   - 如果 `poem.inSquare = true`：显示灰色【已发布广场】（不可点击）

3. **【AI 点评】**
   - 独立按钮，全宽
   - 点击触发 AI 点评
   - 加载时显示"AI 点评中..."

---

### **编辑模式**

```
┌─────────────────────────┐
│ [取消]         [保存]    │ ← 导航栏
├─────────────────────────┤
│   ┌───────────────┐     │
│   │ 标题输入框     │     │
│   ├───────────────┤     │
│   │               │     │
│   │ 正文编辑器     │     │
│   │               │     │
│   └───────────────┘     │
│   字数统计  行数统计      │
└─────────────────────────┘
```

#### 编辑模式特性：
1. **智能保存按钮**
   - 只有修改了标题或内容，导航栏右侧才显示【保存】按钮
   - 未修改时不显示【保存】

2. **取消操作**
   - 点击【取消】恢复原始内容
   - 退出编辑模式

3. **隐藏返回按钮**
   - 编辑时隐藏导航栏返回按钮
   - 防止误操作导致丢失修改

4. **键盘自适应**
   - 键盘弹起时隐藏底部按钮
   - 键盘收起时显示底部按钮

---

## 🔄 交互流程

### 场景 1：查看诗歌
```
进入页面 → 查看模式 → 点击【AI 点评】→ 查看 AI 评价 → 返回
```

### 场景 2：编辑但未修改
```
进入页面 → 查看模式 → 点击【编辑】→ 编辑模式（未修改）→ 点击【取消】→ 查看模式
```

### 场景 3：编辑并保存
```
进入页面 → 查看模式 → 点击【编辑】→ 编辑模式 → 修改内容 → 【保存】按钮出现 → 点击【保存】→ 查看模式（内容已更新）
```

### 场景 4：发布到广场
```
进入页面 → 查看模式 → 点击【发布到广场】→ ShareSheet → 发布成功 → 按钮变为【已发布广场】（灰色）
```

---

## 🆚 对比：旧逻辑 vs 新逻辑

### 旧逻辑（DirectWritingView）
- ❌ 直接进入编辑模式
- ❌ 即使没修改也会触发保存流程
- ❌ 没有"查看"状态
- ❌ 无法区分"已发布"和"未发布"

### 新逻辑（PoemEditorDetailView）
- ✅ 默认查看模式，按需编辑
- ✅ 智能检测修改，只有真正修改才能保存
- ✅ 清晰的查看/编辑状态切换
- ✅ 已发布的诗显示【已发布广场】（不可重复发布）
- ✅ AI 点评独立按钮，随时可用

---

## 💻 技术实现

### 1. 状态管理

```swift
// 编辑状态
@State private var isEditing = false          // 是否处于编辑模式
@State private var editedTitle: String        // 编辑中的标题
@State private var editedContent: String      // 编辑中的内容

// 计算属性：是否有修改
private var hasChanges: Bool {
    editedTitle != poem.title || editedContent != poem.content
}
```

### 2. 智能保存按钮

```swift
.toolbar {
    if isEditing {
        ToolbarItem(placement: .navigationBarLeading) {
            Button("取消") { cancelEditing() }
        }
        
        if hasChanges {  // 只有修改了才显示保存按钮
            ToolbarItem(placement: .navigationBarTrailing) {
                Button("保存") { saveChanges() }
            }
        }
    }
}
```

### 3. 条件渲染按钮

```swift
if poem.inSquare {
    // 已发布状态（灰色，不可点击）
    HStack {
        Image(systemName: "checkmark.circle.fill")
        Text("已发布广场")
    }
    .foregroundColor(Colors.textSecondary)
    .background(Colors.white.opacity(0.5))
} else {
    // 未发布，可以发布
    Button(action: { showingShareSheet = true }) {
        HStack {
            Image(systemName: "square.and.arrow.up")
            Text("发布到广场")
        }
        .foregroundColor(Colors.accentTeal)
    }
}
```

---

## 🎯 用户体验提升

### 1. 减少误操作
- 默认查看模式，不会误修改内容
- 编辑时隐藏返回按钮，防止意外退出

### 2. 清晰的状态提示
- 【已发布广场】灰色显示，用户一眼知道已发布
- 【保存】按钮只在有修改时出现，避免无效操作

### 3. 流畅的交互
- 取消编辑立即恢复原内容
- 保存成功显示 Toast 提示
- 键盘自适应隐藏底部按钮

### 4. 功能聚合
- AI 点评不再占用编辑页面空间
- 发布、编辑、点评功能清晰分离

---

## 📊 改动文件

### 新增
- `BetweenLines/Views/Profile/PoemEditorDetailView.swift`

### 修改
- `BetweenLines/Views/Profile/ProfileView.swift`
  - 修改 `destinationView(for:)` 方法
  - 诗集和草稿跳转到 `PoemEditorDetailView`

---

## 🧪 测试场景

### 基础流程
1. ✅ 进入诗集 → 点击诗歌 → 查看模式正确显示
2. ✅ 点击【编辑】→ 进入编辑模式
3. ✅ 不修改，点击【取消】→ 返回查看模式
4. ✅ 修改内容 → 【保存】按钮出现 → 保存成功

### 发布功能
1. ✅ 未发布的诗 → 显示【发布到广场】按钮
2. ✅ 已发布的诗 → 显示【已发布广场】（灰色）
3. ✅ 点击【发布到广场】→ ShareSheet → 发布成功 → 按钮变灰

### AI 点评
1. ✅ 点击【AI 点评】→ 加载中提示
2. ✅ 点评成功 → 显示 AICommentSheet
3. ✅ 点评失败 → Toast 错误提示

### 键盘适配
1. ✅ 编辑模式 → 点击输入框 → 键盘弹起 → 底部按钮隐藏
2. ✅ 收起键盘 → 底部按钮重新显示

---

## 🚀 后续优化建议

### 短期
1. 考虑添加"删除"功能到编辑详情页
2. 支持分享图片（从详情页直接生成）
3. 添加"复制"功能

### 长期
1. 版本历史记录（保存多个修改版本）
2. 协作编辑（多人共同创作）
3. 评论功能（他人对诗歌的评论）

---

## ✨ 总结

这次优化彻底改善了诗集/草稿的编辑体验：
- ✅ 查看优先，按需编辑
- ✅ 智能保存，避免无效操作
- ✅ 清晰的发布状态提示
- ✅ AI 点评功能独立且随时可用
- ✅ 完美的键盘适配

用户体验更加流畅、直观、高级！🎉

