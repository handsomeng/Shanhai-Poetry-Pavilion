# 山海诗馆 - 诗歌状态流转逻辑梳理

## 一、诗歌核心属性

### 1. 状态相关属性
```swift
isPublished: Bool      // 是否发布（false = 草稿，true = 已发布）
isLiked: Bool          // 当前用户是否点赞
isFavorited: Bool      // 是否收藏
likeCount: Int         // 点赞数
```

### 2. 作者相关属性
```swift
authorName: String     // 作者笔名
```

### 3. 时间相关属性
```swift
createdAt: Date        // 创建时间
updatedAt: Date        // 最后更新时间
```

---

## 二、诗歌来源分类

### 1. 我的诗歌（authorName == currentUserName）
- 草稿（isPublished = false）
- 已发布（isPublished = true）

### 2. 他人的诗歌（authorName != currentUserName）
- 只能是已发布状态（isPublished = true）
- 来自示例数据（Poem.examples）

---

## 三、当前各页面的展示逻辑

### 📝 【写诗】Tab
**功能**：三种创作模式入口
- 直接写诗
- 模仿写诗
- 主题写诗

**没有诗歌列表**

---

### 📖 【学诗】Tab
**功能**：学习内容
**与诗歌无关**

---

### 👁️【赏诗】Tab
**数据源**：`explorePoems`
```swift
explorePoems = allPoems
    .filter { $0.isPublished }
    .sorted { $0.createdAt > $1.createdAt }
```

**筛选选项**：
- 最新：按创建时间排序
- 热门：按点赞数排序
- 随机：随机打乱

**展示内容**：
- ✅ 我的已发布诗歌
- ✅ 他人的已发布诗歌（示例数据）

**交互**：
- 点击进入详情页
- 详情页只有一个居中的点赞按钮

---

### 👤 【我的】Tab
**三个分类**：

#### 1. 诗集（已发布）
**数据源**：`myPublishedPoems`
```swift
myPublishedPoems = allPoems
    .filter { $0.isPublished && $0.authorName == currentUserName }
    .sorted { $0.createdAt > $1.createdAt }
```

**展示内容**：
- ✅ 只展示我发布的诗歌

**交互**：
- ✅ 点击可以编辑
- ✅ 可以删除

#### 2. 草稿
**数据源**：`myDrafts`
```swift
myDrafts = allPoems
    .filter { !$0.isPublished && $0.authorName == currentUserName }
    .sorted { $0.updatedAt > $1.updatedAt }
```

**展示内容**：
- ✅ 只展示我的草稿

**交互**：
- ✅ 点击可以编辑
- ✅ 可以删除

#### 3. 赞过
**数据源**：`myFavorites`
```swift
myFavorites = allPoems
    .filter { $0.isFavorited }
    .sorted { $0.createdAt > $1.createdAt }
```

**展示内容**：
- ✅ 我收藏的诗歌（包括我的和他人的）

**交互**：
- ✅ 点击只能查看（不能编辑）
- ❌ 不能删除（实际上可以删除自己的）

---

## 四、操作流程

### 创作流程
```
1. 【写诗】Tab → 选择创作模式
   ↓
2. 进入编辑页面，开始创作
   ↓
3. 点击【保存】→ 创建草稿（isPublished = false）
   ↓
4. 弹出 ShareSheet
   ↓
5. 选择【分享到广场】→ 发布（isPublished = true）
   或
   直接【完成】→ 保留草稿状态
```

### 编辑流程
```
【我的】Tab → 诗集/草稿 → 点击诗歌
   ↓
进入编辑页面
   ↓
修改内容
   ↓
点击【保存】→ 更新 updatedAt
   ↓
弹出 ShareSheet
   ↓
可选：分享到广场 / 生成图片 / AI 点评
```

### 点赞流程
```
【赏诗】或【我的-诗集】→ 点击诗歌
   ↓
进入详情页
   ↓
点击红心
   ↓
isLiked.toggle()
likeCount += (isLiked ? 1 : -1)
```

### 收藏流程
```
❓ 目前没有收藏按钮的入口
   
数据模型中有 isFavorited 属性
但在 UI 中没有收藏按钮
```

---

## 五、当前存在的问题 ⚠️

### 1. ❌ 收藏功能不完整
**问题**：
- 数据模型有 `isFavorited` 和 `toggleFavorite()` 方法
- 【我的-赞过】Tab 使用的是 `myFavorites` 数据源
- 但 UI 上没有任何地方可以点击"收藏"

**建议**：
- **方案A**：删除收藏功能，【我的-赞过】Tab 改为展示"我点赞过的诗歌"
- **方案B**：在诗歌详情页增加收藏按钮

---

### 2. ⚠️ "赞过" 的语义不清
**问题**：
- Tab 名称是"赞过"
- 但数据源是 `myFavorites`（我收藏的）
- 点赞用的是 `isLiked` 属性
- 收藏用的是 `isFavorited` 属性

**目前的混乱**：
- "赞过" 字面意思 = 我点过赞的诗歌（`isLiked`）
- 实际展示 = 我收藏的诗歌（`isFavorited`）

**建议**：
- **方案A**：Tab 改名为"收藏"，并在详情页增加收藏按钮
- **方案B**：Tab 保持"赞过"，数据源改为 `allPoems.filter { $0.isLiked }`

---

### 3. ⚠️ 草稿可以被"发布多次"
**问题**：
- 草稿点击【保存】后，会弹出 ShareSheet
- 可以点击【分享到广场】发布
- 发布后，再次编辑这首诗，还会弹出 ShareSheet
- 可以再次点击【分享到广场】（虽然已经是 `isPublished = true`）

**建议**：
- ShareSheet 中，如果 `poem.isPublished == true`，隐藏【分享到广场】按钮

---

### 4. ⚠️ 他人的诗歌可以被点赞，但数据不共享
**问题**：
- 示例诗歌（他人的诗歌）初始有点赞数（如 23, 45, 67）
- 用户可以点赞这些诗歌
- 但点赞后，`likeCount` 只是本地修改，不会同步

**目前的行为**：
- 用户点赞 → likeCount +1 → 保存到本地 UserDefaults
- 但示例诗歌不应该被修改

**建议**：
- 他人的诗歌点赞应该是"只读"的
- 或者分离"我的诗歌"和"公共诗歌"的存储

---

### 5. ⚠️ 广场上会展示我自己的诗歌
**问题**：
- 【赏诗】Tab 的广场会展示所有 `isPublished = true` 的诗歌
- 包括我自己发布的诗歌

**是否合理**？
- **如果是社交应用**：合理，广场就是所有人的诗歌
- **如果偏个人创作工具**：不合理，广场应该只看别人的

**建议**：
- 明确产品定位：
  - **社交型**：保持现状
  - **个人工具型**：广场过滤掉自己的诗歌

---

### 6. ✅ 已修复：诗集中的诗可以编辑
**之前的问题**：
- 【我的-诗集】中的诗点击后只能查看，不能编辑

**已修复**：
- 现在【诗集】和【草稿】中的诗都可以编辑
- 【赞过】中的诗只能查看（因为可能是别人的）

---

## 六、建议的优化方案

### 方案 A：极简化（推荐）
**改动最小，逻辑最清晰**

#### 1. 删除收藏功能
- 删除 `isFavorited` 相关代码
- 删除 `toggleFavorite()` 方法
- 诗歌详情页只保留点赞

#### 2. 【我的】Tab 调整
- 诗集：我的已发布诗歌
- 草稿：我的未发布诗歌
- **赞过** → 改为**浏览记录**或直接删除这个Tab

#### 3. ShareSheet 优化
- 如果 `poem.isPublished == true`，隐藏【分享到广场】按钮

#### 4. 广场逻辑
- **保持现状**：展示所有人的诗歌（包括自己的）
- 或者：增加筛选选项"全部/他人"

---

### 方案 B：完善收藏功能
**增加功能，更像社交产品**

#### 1. 增加收藏按钮
- 诗歌详情页增加收藏按钮（心形旁边）
- 点击收藏 → `isFavorited.toggle()`

#### 2. 【我的-赞过】改名
- **赞过** → 改为**收藏**
- 数据源保持 `myFavorites`

#### 3. 区分点赞和收藏
- **点赞**：快速的情感反馈，会增加 `likeCount`
- **收藏**：个人收藏夹，方便以后查看

#### 4. 增加"我点赞的"页面
- 可以在【我的】增加第四个Tab："我点赞的"
- 数据源：`allPoems.filter { $0.isLiked }`

---

### 方案 C：社交化（最复杂）
**如果要做成社交产品**

#### 需要后端支持
- 诗歌存储在服务器
- 点赞、收藏同步到服务器
- 用户系统（登录、关注、评论等）

---

## 七、我的推荐

基于你之前强调的"极简"、"高级"、"留白"设计理念，我推荐：

### 🎯 方案 A：极简化

**具体改动**：

1. **删除收藏功能**
   - 移除 `isFavorited` 属性
   - 移除 `toggleFavorite()` 方法

2. **【我的】Tab 只保留两个分类**
   - 诗集（已发布）
   - 草稿（未发布）
   - ❌ 删除"赞过"Tab

3. **ShareSheet 优化**
   - 已发布的诗，不再显示【分享到广场】按钮

4. **广场保持现状**
   - 展示所有已发布的诗歌（包括自己的）

**优点**：
- ✅ 逻辑清晰，状态简单
- ✅ 符合极简设计理念
- ✅ 聚焦创作本身，而非社交

**你觉得这个方案如何？或者有其他想法？**

