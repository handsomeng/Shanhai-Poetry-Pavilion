# 订阅系统配置指南

## ✅ 已完成的功能

### Phase 1: 核心订阅框架 ✅

1. **订阅产品定义**
   - 月卡：¥9.9/月
   - 季卡：¥19.9/3个月（推荐）
   - 年卡：¥69.9/年（最划算）

2. **订阅管理器**
   - StoreKit 2 集成
   - 自动续费监听
   - 订阅状态管理
   - 恢复购买功能

3. **会员权益**
   - AI 点评无限次（免费用户每天 3 次）
   - 购买页面精美 UI
   - 【我的】页面会员卡片
   - 超限后自动引导购买

---

## 📋 你需要在 App Store Connect 配置

### Step 1: 创建 App 内购买项目

1. **登录 App Store Connect**
   - https://appstoreconnect.apple.com

2. **进入你的 App**
   - 选择"山海诗馆"

3. **创建订阅组**
   - 导航：App 内购买项目 → 管理
   - 点击"+"→ 选择"自动续期订阅"
   - 创建订阅组：
     - **订阅组名称**：山海诗馆会员
     - **订阅组参考名称**：shanhai_poetry_membership

4. **创建 3 个订阅产品**

#### 产品 1：月卡
```
产品 ID：com.shanhai.poetry.monthly
参考名称：月卡会员
订阅时长：1 个月
价格：¥9.90
```

**本地化信息（简体中文）**：
- 显示名称：月卡
- 描述：解锁全部高级功能，每月自动续费

**审核信息截图**：
- 需要提供订阅购买页面截图
- 会员权益说明截图

---

#### 产品 2：季卡（推荐）
```
产品 ID：com.shanhai.poetry.quarterly
参考名称：季卡会员
订阅时长：3 个月
价格：¥19.90
推广性优惠：可选
```

**本地化信息（简体中文）**：
- 显示名称：季卡
- 描述：解锁全部高级功能，每 3 个月自动续费，省 33%

---

#### 产品 3：年卡
```
产品 ID：com.shanhai.poetry.yearly
参考名称：年卡会员
订阅时长：1 年
价格：¥69.90
```

**本地化信息（简体中文）**：
- 显示名称：年卡
- 描述：解锁全部高级功能，每年自动续费，省 41%

---

### Step 2: 配置 Xcode 项目

1. **打开 Xcode**
   - 打开 `BetweenLines.xcodeproj`

2. **选择 Target**
   - 选择 `BetweenLines`

3. **配置 Capabilities**
   - 点击 `Signing & Capabilities`
   - 点击 `+ Capability`
   - 添加 `In-App Purchase`

4. **配置 StoreKit Configuration（可选，用于本地测试）**
   - File → New → File
   - 选择 `StoreKit Configuration File`
   - 命名为 `Products.storekit`
   - 添加你的 3 个订阅产品

---

### Step 3: 创建沙盒测试账号

1. **App Store Connect → 用户和访问**
   - 选择"沙盒技术测试员"
   - 点击"+"创建新测试员

2. **测试账号信息**
```
邮箱：test1@shanhai.com（任意，不需要真实存在）
密码：Test1234（自己设置）
名字：测试用户1
国家/地区：中国
```

3. **在 iPhone 上使用沙盒账号测试**
   - 设置 → App Store → 沙盒账户
   - 登录你创建的测试账号

---

## 🧪 测试流程

### 1. 构建到真机

```bash
# 在 Xcode 中
1. 选择你的 iPhone 设备
2. Product → Run (⌘R)
```

### 2. 测试免费功能

1. 打开 App
2. 进入【我的】页面
3. 点击【AI 点评】
   - 第 1 次：正常使用 ✅
   - 第 2 次：正常使用 ✅
   - 第 3 次：正常使用 ✅
   - 第 4 次：显示"今日 AI 点评次数已用完（0/3）" ✅
   - 自动弹出订阅页面 ✅

### 3. 测试购买流程

1. 点击【我的】页面的会员卡片
2. 选择"季卡"（推荐）
3. 点击【立即订阅】
4. 使用沙盒账号购买
5. 购买成功后：
   - 显示"订阅成功"Toast ✅
   - 会员卡片变为"会员已激活" ✅
   - 用户名旁边显示皇冠图标 ✅
   - AI 点评无限次 ✅

### 4. 测试恢复购买

1. 删除 App
2. 重新安装
3. 进入订阅页面
4. 点击【恢复购买】
5. 订阅状态自动恢复 ✅

---

## ⚠️ 注意事项

### 1. 沙盒测试的特点

- ✅ 不会真实扣费
- ✅ 订阅时长加速（1 个月 = 5 分钟）
- ❌ 需要使用沙盒测试账号
- ❌ 不能使用真实的 Apple ID

### 2. 审核要点

**苹果会检查**：
- ✅ 订阅项目是否在 App Store Connect 配置
- ✅ 是否使用 StoreKit 2
- ✅ 免费功能是否足够（不能付费墙）
- ✅ 订阅取消说明是否清楚
- ✅ 隐私政策和服务条款

**我们已经做好的**：
- ✅ 免费用户可以写诗、保存、发布
- ✅ 免费用户有 3 次 AI 点评
- ✅ 购买页面有取消说明
- ✅ 使用 StoreKit 2 原生支付

### 3. 分成比例

- 🍎 苹果抽成：30%
- 💰 你的收入：70%

**例如**：
- 季卡 ¥19.9 → 你实际收入 ¥13.93
- 年卡 ¥69.9 → 你实际收入 ¥48.93

---

## 📊 当前状态

| 功能 | 状态 | 说明 |
|------|------|------|
| 订阅产品定义 | ✅ | 完成 |
| 订阅管理器 | ✅ | 完成 |
| 购买页面 UI | ✅ | 完成 |
| AI 点评限额 | ✅ | 免费 3 次/天 |
| 会员卡片 | ✅ | 【我的】页面 |
| 图片风格系统 | ⏳ | 下一阶段 |
| AI 生成模板 | ⏳ | 下一阶段 |
| 字体样式选择 | ⏳ | 下一阶段 |

---

## 🚀 下一步

### 你需要做的（今天）

1. ✅ **配置 App Store Connect**
   - 创建订阅组
   - 创建 3 个订阅产品
   - 创建沙盒测试账号

2. ✅ **配置 Xcode**
   - 添加 In-App Purchase Capability
   - （可选）创建 StoreKit Configuration 文件

3. ✅ **测试购买流程**
   - 构建到真机
   - 使用沙盒账号测试购买
   - 测试恢复购买

### 我接下来要做的（明天）

1. **图片风格系统**
   - 基础、水墨、花卉 3 种风格
   - 会员才能使用高级风格

2. **AI 生成模板**
   - 模仿写诗：AI 生成模板
   - 主题写诗：AI 推荐主题

3. **字体样式选择**
   - 宋体、楷体、行楷等

---

## 💡 Tips

### 如果购买失败

1. 检查是否登录沙盒账号
2. 检查产品 ID 是否正确
3. 检查订阅组是否创建
4. 检查 Xcode Capability 是否添加

### 如果需要修改价格

- App Store Connect → 订阅管理 → 编辑价格
- 修改后需要重新提交审核

### 如果需要添加优惠

- App Store Connect → 订阅管理 → 促销优惠
- 可以设置首月优惠（如首月 ¥4.9）

---

## 📞 需要帮助？

如果配置过程中遇到问题，随时告诉我：
- 截图错误信息
- 描述问题现象
- 我会立即帮你解决！

---

## 🎉 总结

Phase 1 已完成：
- ✅ 订阅系统核心框架
- ✅ 购买页面精美 UI
- ✅ AI 点评限额逻辑
- ✅ 会员状态管理

**接下来只需要**：
1. 你配置 App Store Connect（约 30 分钟）
2. 测试购买流程（约 15 分钟）
3. 明天我继续做图片风格和 AI 功能

整个订阅系统预计**2-3 天内全部完成**！🚀

